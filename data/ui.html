<!doctype html><!-- v2 --><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>CUBERT</title><style>body{font-family:system-ui,Arial,Helvetica,sans-serif;margin:16px;background:#111;color:#eee}._{background:#1b1b1b;border-radius:14px;padding:14px;margin-bottom:12px;box-shadow:0 2px 10px #0008}.r{display:flex;gap:10px;flex-wrap:wrap;align-items:center}.row{display:flex;gap:10px;align-items:center;margin-top:8px}label{font-size:12px;color:#aaa;margin-right:6px}.lab{width:86px;text-align:right;color:#aaa;font-size:12px}input[type=range]{width:220px}select,button,input{background:#222;color:#eee;border:1px solid #333;border-radius:8px;padding:6px}button{cursor:pointer}.b{display:inline-block;padding:3px 8px;border-radius:999px;background:#2a2a2a;margin-left:8px;font-size:12px}.cw{position:relative;width:220px;height:220px}.w{border-radius:50%;cursor:crosshair;border:1px solid #333;background:#000}._m{position:absolute;width:12px;height:12px;border:2px solid #fff;border-radius:50%;box-shadow:0 0 4px #000;pointer-events:none;transform:translate(-6px,-6px)}.tabs{display:flex;gap:8px;margin-bottom:12px}.tabs button{background:#222}.active{background:#2b2b2b}.hide{display:none}h2{margin:0 0 8px 0}#plList .r{justify-content:space-between}</style></head><body><div class=tabs><button id=tMain class=active>Main</button><button id=tPl>Playlists</button><button id=tPr>Presets</button></div><div class="_"><label>Master Brightness</label><input id=gbr type=range min=10 max=100 value=100><span class=b id=wsb>ws:…</span></div><div id=pMain><div class="_"><h2>Face <span id=f>?</span> <span class=b id=s>connecting…</span></h2><div class=r><label>Pattern</label><select id=p><option value=0>Solid</option><option value=1>Band</option><option value=2>Checker</option><option value=3>Rainbow</option></select><label>Speed</label><input id=spd type=range min=1 max=100 value=30><label>Reverse</label><input id=rev type=checkbox><label>Face Brightness</label><input id=br type=range min=5 max=30 value=30><button id=def>Reset Pattern</button></div></div><div class="_"><h3>Main color</h3><div class=cw><canvas id=w1 width=220 height=220 class=w></canvas><div id=m1 class=_m></div></div><div class=row><div class=lab>Saturation</div><input id=s1 type=range min=0 max=255 value=255></div><div class=row><div class=lab>Brightness</div><input id=v1 type=range min=0 max=255 value=200></div></div><div class="_"><h3>Second color</h3><div class=cw><canvas id=w2 width=220 height=220 class=w></canvas><div id=m2 class=_m></div></div><div class=row><div class=lab>Saturation</div><input id=s2 type=range min=0 max=255 value=0></div><div class=row><div class=lab>Brightness</div><input id=v2 type=range min=0 max=255 value=0></div></div><div class="_"><h3>Layers</h3><div class=r><label>Enable Overlay</label><input id=ovr type=checkbox><label>Overlay Pattern</label><select id=ovrPat><option value=0>Solid</option><option value=1>Band</option><option value=2>Checker</option><option value=3>Rainbow</option></select><label>Blend</label><select id=blend><option value=0>Alpha</option><option value=1>Add</option><option value=2>Max</option><option value=3>Multiply</option><option value=4>Screen</option></select><label>Opacity</label><input id=ovrA type=range min=0 max=255 value=128><label>Speed</label><input id=ovrSpd type=range min=1 max=100 value=30></div><div class=r><label>Overlay Colors</label><select id=ovcMode><option value=0>Use Base</option><option value=1>Use Overlay</option></select></div><div id=ovcUI class="r hide"><div><div class=cw><canvas id=ow1 width=220 height=220 class=w></canvas><div id=om1 class=_m></div></div><div class=row><div class=lab>Saturation</div><input id=os1 type=range min=0 max=255 value=255></div><div class=row><div class=lab>Brightness</div><input id=ov1 type=range min=0 max=255 value=200></div></div><div><div class=cw><canvas id=ow2 width=220 height=220 class=w></canvas><div id=om2 class=_m></div></div><div class=row><div class=lab>Saturation</div><input id=os2 type=range min=0 max=255 value=0></div><div class=row><div class=lab>Brightness</div><input id=ov2b type=range min=0 max=255 value=0></div></div></div></div></div><div id=pPl style=display:none><div class="_"><h3>Playlists</h3><div class=r><label>Step Duration(s)</label><input id=plDur type=number min=1 max=600 step=1 value=10><button id=plAdd>Use Current</button><select id=plPreset></select><button id=plAddPreset>Add Preset</button><button id=plPlay>Play</button><button id=plStop>Stop</button><label>Loop</label><input id=plLoop type=checkbox><span class=b id=plInfo>0 steps</span></div><div id=plList></div></div></div><div id=pPr style=display:none><div class="_"><h3>Presets</h3><div class=r><input id=prName placeholder="Preset name"><button id=prSave>Save Preset</button><span class=b id=prInfo></span></div><div id=prList></div></div></div><script>let ws,up=false,F=255,H=160,S=255,V=200,H2=0,S2=0,V2=0,OVR=false,OPAT=1,BLD=0,OPA=128,OVC=0,OH=160,OS=255,OV=200,OH2=0,OS2=0,OV2=0,OSPD=30,PRN={};function q(i){return document.getElementById(i)}function drawWheel(c){const x=c.getContext("2d"),w=c.width,h=c.height,C=w/2,D=h/2,R=Math.min(C,D)-1,i=x.createImageData(w,h),d=i.data;function hsv2rgb(hh,ss,vv){hh/=255;ss/=255;vv/=255;let I=Math.floor(hh*6),f=hh*6-I,p=vv*(1-ss),Q=vv*(1-f*ss),t=vv*(1-(1-f)*ss),r,g,b;switch(I%6){case 0:r=vv;g=t;b=p;break;case 1:r=Q;g=vv;b=p;break;case 2:r=p;g=vv;b=t;break;case 3:r=p;g=Q;b=vv;break;case 4:r=t;g=p;b=vv;break;default:r=vv;g=p;b=Q}return[r*255,g*255,b*255]}for(let y=0;y<h;y++)for(let e=0;e<w;e++){const u=e-C,v=y-D,r=Math.sqrt(u*u+v*v);const o=(y*w+e)*4;if(r>R){d[o+3]=0;continue}let a=Math.atan2(v,u);if(a<0)a+=Math.PI*2;const hh=Math.round((a/(Math.PI*2))*255),ss=Math.min(255,Math.round((r/R)*255));const g=hsv2rgb(hh,ss,255);d[o]=g[0];d[o+1]=g[1];d[o+2]=g[2];d[o+3]=255}x.putImageData(i,0,0)}function mark(m,cv,h,s){const w=cv.width,hc=cv.height,C=w/2,D=hc/2,R=Math.min(C,D)-1,a=(h/255)*Math.PI*2,r=(s/255)*R,x=C+Math.cos(a)*r,y=D+Math.sin(a)*r;m.style.left=x+'px';m.style.top=y+'px'}function throttle(fn,ms){let t=0,last=null,pend=false;return function(...a){const n=Date.now();last=a;if(n-t>=ms){t=n;fn.apply(null,a);pend=false}else if(!pend){pend=true;setTimeout(()=>{t=Date.now();fn.apply(null,last);pend=false},ms-(n-t))}}}function wheel(cv,mk,setter){const rect=()=>cv.getBoundingClientRect(),C=cv.width/2,D=cv.height/2,R=Math.min(C,D)-1;const sendTh=throttle((hh,ss)=>setter(hh,ss),50);function setFrom(e){const r=rect(),x=(e.touches?e.touches[0].clientX:e.clientX)-r.left,y=(e.touches?e.touches[0].clientY:e.clientY)-r.top,dx=x-C,dy=y-D;let ang=Math.atan2(dy,dx);if(ang<0)ang+=Math.PI*2;let rad=Math.sqrt(dx*dx+dy*dy);if(rad>R)rad=R;const hh=Math.round((ang/(Math.PI*2))*255),ss=Math.round((rad/R)*255);sendTh(hh,ss);mark(mk,cv,hh,ss)}cv.addEventListener('mousedown',e=>{setFrom(e);const mv=ev=>setFrom(ev),upF=()=>{window.removeEventListener('mousemove',mv);window.removeEventListener('mouseup',upF)};window.addEventListener('mousemove',mv);window.addEventListener('mouseup',upF)});cv.addEventListener('touchstart',e=>{setFrom(e)},{passive:true});cv.addEventListener('touchmove',e=>{setFrom(e)},{passive:true})}function send(o){if(ws&&ws.readyState===1)ws.send(JSON.stringify(o))}function sendThrottled(ms){return throttle(o=>send(o),ms)}const send40=sendThrottled(40);function wsTarget(){const h=location.host;if(h&&h!=='')return h;return'192.168.4.1'}function connect(){const prot=(location.protocol==='https:')?'wss':'ws';const h=wsTarget();let pInt=null;function open(){try{ws=new WebSocket(prot+'://'+h+'/ws');ws.onopen=()=>{q('s').textContent='connected';q('wsb').textContent='ws:'+h;if(pInt)clearInterval(pInt);pInt=setInterval(()=>send({cmd:'ping'}),3000);send({cmd:'prg_list'});send({cmd:'pl_fetch'})};ws.onclose=()=>{q('s').textContent='reconnecting…';if(pInt)clearInterval(pInt);setTimeout(open,800)};ws.onmessage=ev=>{try{const m=JSON.parse(ev.data);if(m.state){up=true;F=m.state.face;q('f').textContent=(F==255?'?':F);q('p').value=m.state.pattern_idx??0;q('br').value=m.state.brightness??30;q('gbr').value=m.state.gbr??100;document.getElementById('ovr').checked=!!m.state.ovr;document.getElementById('ovrPat').value=m.state.ovr_idx??1;document.getElementById('blend').value=m.state.blend_idx??0;document.getElementById('ovrA').value=m.state.ovrA??128;q('ovrSpd').value=m.state.ovrSpd??30;OSPD=m.state.ovrSpd??30;const p=m.params||{};q('spd').value=p.speed??30;q('rev').checked=!!p.reverse;H=p.hue??160;S=p.sat??255;V=p.val??200;H2=p.hue2??0;S2=p.sat2??0;V2=p.val2??0;q('s1').value=S;q('v1').value=V;q('s2').value=S2;q('v2').value=V2;mark(q('m1'),q('w1'),H,S);mark(q('m2'),q('w2'),H2,S2);const o=m.ovc||{};OVC=o.use?1:0;OH=o.h??H;OS=o.s??S;OV=o.v??V;OH2=o.h2??H2;OS2=o.s2??S2;OV2=o.v2??V2;q('ovcMode').value=OVC;q('os1').value=OS;q('ov1').value=OV;q('os2').value=OS2;q('ov2b').value=OV2;if(OVC){q('ovcUI').classList.remove('hide')}else{q('ovcUI').classList.add('hide')}mark(q('om1'),q('ow1'),OH,OS);mark(q('om2'),q('ow2'),OH2,OS2);up=false}if(m.pl&&m.pl.face==F){renderPL(m.pl)}if(m.presetsG){renderPresetsG(m.presetsG)}}catch(e){}}}catch(_){setTimeout(open,1200)}}open()}function onChange(id,fn,th=false){const el=q(id);const fire=(e)=>{if(up)return;fn(el,e)};if(th){const thr=throttle(()=>fn(el),50);el.addEventListener('input',()=>{if(up)return;thr()});el.addEventListener('change',fire)}else{el.addEventListener('input',fire);el.addEventListener('change',fire)}}function tabs(){const m=q('tMain'),pl=q('tPl'),pr=q('tPr'),pM=q('pMain'),pP=q('pPl'),pR=q('pPr');function act(x){m.classList.remove('active');pl.classList.remove('active');pr.classList.remove('active');pM.style.display='none';pP.style.display='none';pR.style.display='none';if(x==='pl'){pl.classList.add('active');pP.style.display='block';send({cmd:'pl_fetch'});send({cmd:'prg_list'})}else if(x==='pr'){pr.classList.add('active');pR.style.display='block';send({cmd:'prg_list'})}else{m.classList.add('active');pM.style.display='block';send({cmd:'pl_stop'})}}m.onclick=()=>act('main');pl.onclick=()=>act('pl');pr.onclick=()=>act('pr')}function renderPL(m){const l=m.l||[];q('plInfo').textContent=l.length+' steps';const root=q('plList');root.innerHTML='';l.forEach((st,i)=>{const row=document.createElement('div');row.className='r';const nm=(st.kind==1?('['+(PRN[st.pi]||('Preset '+(st.pi??0)))+']'):(['Solid','Band','Checker','Rainbow','Twinkle','Noise','Sinewave'][st.p]||'P'));const sp=document.createElement('span');sp.textContent=(i+1)+'. '+nm+' '+st.sec+'s';row.appendChild(sp);const upb=document.createElement('button');upb.textContent='▲';upb.onclick=()=>send({cmd:'pl_move',i:i,dir:-1});row.appendChild(upb);const dnb=document.createElement('button');dnb.textContent='▼';dnb.onclick=()=>send({cmd:'pl_move',i:i,dir:1});row.appendChild(dnb);const del=document.createElement('button');del.textContent='✖';del.onclick=()=>send({cmd:'pl_del',i:i});row.appendChild(del);root.appendChild(row)});q('plLoop').checked=!!m.loop}function renderPresetsG(m){const l=m.l||[];q('prInfo').textContent=l.length+' items';PRN={};const root=q('prList');root.innerHTML='';const dd=q('plPreset');dd.innerHTML='';l.forEach(st=>{PRN[st.i]=st.name||('Preset '+st.i);const row=document.createElement('div');row.className='r';const name=document.createElement('span');name.textContent=PRN[st.i];row.appendChild(name);const ap=document.createElement('button');ap.textContent='Apply';ap.onclick=()=>send({cmd:'prg_apply',i:st.i});row.appendChild(ap);const du=document.createElement('button');du.textContent='Duplicate';du.onclick=()=>{const nn=prompt('Duplicate name',PRN[st.i]+' Copy');if(nn&&nn.length)send({cmd:'prg_dup',i:st.i,name:nn})};row.appendChild(du);const rn=document.createElement('button');rn.textContent='Rename';rn.onclick=()=>{const nn=prompt('New name',PRN[st.i]);if(nn&&nn.length)send({cmd:'prg_ren',i:st.i,name:nn})};row.appendChild(rn);const de=document.createElement('button');de.textContent='Delete';de.onclick=()=>send({cmd:'prg_del',i:st.i});row.appendChild(de);root.appendChild(row);const opt=document.createElement('option');opt.value=st.i;opt.textContent=PRN[st.i];dd.appendChild(opt)})}drawWheel(q('w1'));drawWheel(q('w2'));drawWheel(q('ow1'));drawWheel(q('ow2'));wheel(q('w1'),q('m1'),(h,s)=>{H=h;S=s;send40({cmd:'param',k:'hue',v:H});send40({cmd:'param',k:'sat',v:S})});wheel(q('w2'),q('m2'),(h,s)=>{H2=h;S2=s;send40({cmd:'param',k:'hue2',v:H2});send40({cmd:'param',k:'sat2',v:S2})});wheel(q('ow1'),q('om1'),(h,s)=>{OH=h;OS=s;send40({cmd:'ovc',k:'h',v:OH});send40({cmd:'ovc',k:'s',v:OS})});wheel(q('ow2'),q('om2'),(h,s)=>{OH2=h;OS2=s;send40({cmd:'ovc',k:'h2',v:OH2});send40({cmd:'ovc',k:'s2',v:OS2})});function onChangePair(id,key){onChange(id,el=>send40({cmd:'param',k:key,v:parseInt(el.value)}),true)}onChange('p',el=>send({cmd:'pattern_idx',v:parseInt(el.value)}));onChangePair('spd','speed');onChange('rev',el=>send({cmd:'param',k:'reverse',v:el.checked?1:0}));onChangePair('br','brightness');onChangePair('s1','sat');onChangePair('v1','val');onChangePair('s2','sat2');onChangePair('v2','val2');onChangePair('gbr','gbr');onChange('ovrA',el=>send40({cmd:'overlay',a:parseInt(el.value)}),true);onChange('ovrSpd',el=>send40({cmd:'overlay',speed:parseInt(el.value)}),true);onChange('blend',el=>send({cmd:'overlay',blendIdx:parseInt(el.value)}));onChange('ovrPat',el=>send({cmd:'overlay',pat:parseInt(el.value)}));q('ovr').addEventListener('change',e=>send({cmd:'overlay',en:e.target.checked?1:0}));q('ovcMode').addEventListener('change',e=>{const v=parseInt(e.target.value);send({cmd:'ovcMode',v:v});if(v){q('ovcUI').classList.remove('hide')}else{q('ovcUI').classList.add('hide')}});q('os1').addEventListener('input',e=>send40({cmd:'ovc',k:'s',v:parseInt(e.target.value)}));q('ov1').addEventListener('input',e=>send40({cmd:'ovc',k:'v',v:parseInt(e.target.value)}));q('os2').addEventListener('input',e=>send40({cmd:'ovc',k:'s2',v:parseInt(e.target.value)}));q('ov2b').addEventListener('input',e=>send40({cmd:'ovc',k:'v2',v:parseInt(e.target.value)}));q('def').onclick=()=>send({cmd:'defaults'});q('plAdd').onclick=()=>{const s=parseInt(q('plDur').value)||10;send({cmd:'pl_add',sec:s})};q('plAddPreset').onclick=()=>{const s=parseInt(q('plDur').value)||10;const pi=parseInt(q('plPreset').value)||0;send({cmd:'pl_add_preset',sec:s,pi:pi})};q('plPlay').onclick=()=>send({cmd:'pl_play'});q('plStop').onclick=()=>send({cmd:'pl_stop'});q('plLoop').onchange=e=>send({cmd:'pl_loop',v:e.target.checked?1:0});q('prSave').onclick=()=>{const n=q('prName').value||'';send({cmd:'prg_save',name:n})};(function(){tabs();connect()})();</script></body></html>
